# This workflow uses actions that are not certified by GitHub.
# SÃ£o fornecidas por terceiros e regidas por
# termos de serviÃ§o, polÃ­tica de privacidade e suporte separados
# documentaÃ§Ã£o.

name: main

on:
  push:
    branches: [ main ]
  pull_request:
    branches: ["main"]

jobs:
  env:
    uses: devxp-tech/.github/.github/workflows/env.yaml@main

  # test:
  #   uses: devxp-tech/.github/.github/workflows/test.yaml@main

  quality-gate:
    uses: devxp-tech/.github/.github/workflows/sonarqube.yaml@main
    secrets: inherit

  build:
    name: Yarn Build ğŸ”¨
    runs-on: ubuntu-latest
    needs:
      - env
      # - test
      - quality-gate
    steps:
      - name: app checkout
        uses: actions/checkout@v3

      - name: Configure Node.js 16.x
        uses: actions/setup-node@v3
        with:
          node-version: 16.x

      - name: Cache node_modules
        id: cache-modules
        uses: actions/cache@v3
        with:
          path: app/node_modules
          key: npm-build-${{ hashFiles('app/package-lock.json') }}
          restore-keys: |
            npm-build-
            npm-

      - name: yarn install and build
        run: |
          cd app/
          yarn add --cwd packages/app @backstage/plugin-sonarqube
          yarn install --frozen-lockfile
          yarn tsc
          yarn build

      - name: persist build files
        uses: actions/upload-artifact@v3
        with:
          name: app-folder
          path: app/packages/backend/dist
          if-no-files-found: error

  build-and-push:
    name: Build and Push ğŸ“¦
    runs-on: ubuntu-latest
    needs:
      - env
      - build
      - quality-gate
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3

      - name: Set rev.txt ğŸ› ï¸
        run: git show -s --format="%ai %H %s %aN" HEAD > rev.txt

      - name: grant dist folder exists
        run: mkdir -p app/packages/backend/dist

      - name: restore build files
        uses: actions/download-artifact@v3
        with:
          name: app-folder
          path: app/packages/backend/dist

      - name: verify artifacts before
        run: ls -lRa app/packages/backend/dist

      - name: Login Docker Registry ğŸªª
        uses: docker/login-action@v2.1.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Build and Push Docker ğŸš€
        run: |
          cd app/
          docker image build . -f packages/backend/Dockerfile --tag ghcr.io/devxp-tech/backstage:${{ needs.env.outputs.tag }}
          docker push ghcr.io/devxp-tech/backstage:${{ needs.env.outputs.tag }}

  security-gateway:
    uses: devxp-tech/.github/.github/workflows/trivy.yaml@main
    needs:
      - build-and-push

  deploy:
    name: GitOps Deploy ğŸ—ï¸
    runs-on: ubuntu-latest
    needs:
      - env
      - security-gateway

    steps:
    - name: Set Kustomize ğŸ› ï¸
      uses: imranismail/setup-kustomize@v1
      with:
        kustomize-version: "3.9.4"

    - name: GitOps Checkout ğŸ›ï¸
      run: |
        git clone https://${{ secrets.ACCESS_TOKEN_GITHUB }}@github.com/devxp-tech/gitops
        cd gitops
        git config user.name "$GITHUB_ACTOR"
        git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

    - name: Update Docker Image Tag âœ¨
      run: |
        cd gitops/apps/backstage/base
        OLD_TAG=$(cat kustomization.yaml | grep 'tag:' |  awk '{print $2}')
        NEW_TAG=${{ needs.env.outputs.tag }}
        # kustomize edit set image diegoluisi/backstage:${{ needs.env.outputs.tag }}
        sed -i "s|$OLD_TAG|$NEW_TAG|g" kustomization.yaml

    - name: Commit and Push ğŸš€
      run: |
        cd gitops/
        git commit -am ":robot: [GitHub Action] Set new image tag to https://github.com/devxp-tech/backstage/commit/${{ needs.env.outputs.tag }}"
        git push

  notify:
    uses: devxp-tech/.github/.github/workflows/notify.yaml@main
    if: always()
    secrets: inherit
    needs:
      - deploy
